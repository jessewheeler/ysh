extends layout

block content
    section.section.alt-bg
        .container
            h2 Renew Your Membership
            p.text-center
                | Welcome back, #{member.first_name}! Your information is pre-filled below.
                | Review and update anything that's changed, then continue to payment.

            if member.expiry_date
                p.text-center.text-muted
                    | Your membership expires on #{new Date(member.expiry_date).toLocaleDateString('en-US', {
                    year: 'numeric',
month: 'long',
day: 'numeric'
})}.

    form.contact-form(method="POST" action=`/renew/${token}`)
    input(type="hidden" name="_csrf" value=(typeof csrfToken !== 'undefined' ? csrfToken : ''))

    //- Membership type display (read-only for renewals)
    .form-group
    label Membership Type
    p(style="padding:8px 0; font-weight:bold; text-transform:capitalize;") #{member.membership_type} â€” $#{(member.membership_type === 'family' ? familyDues : individualDues) / 100 | 0}.00
    input(type="hidden" name="membership_type" value=member.membership_type)

    //- Primary Member Information
    h3(style="margin-top: 1.5rem;") Your Information
    .form-group
    label(for="first_name") First Name
    input#first_name(type="text" name="first_name" value=member.first_name required)
    .form-group
    label(for="last_name") Last Name
    input#last_name(type="text" name="last_name" value=member.last_name required)
    .form-group
    label(for="email") Email (cannot be changed)
    input#email(type="email" value=member.email disabled)
    .form-group
    label(for="phone") Phone (optional)
    input#phone(type="tel" name="phone" value=(member.phone || ''))
    .form-group
    label(for="address_street") Street Address (optional)
    input#address_street(type="text" name="address_street" value=(member.address_street || ''))
    .form-group
    label(for="address_city") City
    input#address_city(type="text" name="address_city" value=(member.address_city || ''))
    .form-group
    label(for="address_state") State
    input#address_state(type="text" name="address_state" value=(member.address_state || 'MT'))
    .form-group
    label(for="address_zip") ZIP Code
    input#address_zip(type="text" name="address_zip" value=(member.address_zip || ''))

    //- Family members (editable)
    if member.membership_type === 'family'
    h3(style="margin-top: 1.5rem;") Family Members
    p.text-muted
    | You may have up to #{maxFamilyMembers - 1} additional family members. Each will receive their own membership card.

    #family-members-container
    each fm, i in familyMembers
    .family-member-row(style="border:1px solid #ddd; padding:1rem; margin-bottom:1rem; border-radius:4px; position:relative;")
    button.remove-family-member(type="button" style="position:absolute; top:0.5rem; right:0.5rem; background:#dc3545; color:white; border:none; border-radius:3px; padding:0.25rem 0.5rem; cursor:pointer;") Remove
    input(type="hidden" name=`family_members[${i}][id]` value=fm.id)
    .form-group
    label First Name
    input(type="text" name=`family_members[${i}][first_name]` value=fm.first_name required)
    .form-group
    label Last Name
    input(type="text" name=`family_members[${i}][last_name]` value=fm.last_name required)
    .form-group
    label Email (optional)
    input(type="email" name=`family_members[${i}][email]` value=(fm.email && fm.email !== member.email ? fm.email : ''))

    button.btn-outline(type="button" id="add-family-member" style=(familyMembers.length >= maxFamilyMembers - 1 ? 'display:none' : '')) + Add Family Member

    button.btn(type="submit" style="margin-top: 2rem;") Continue to Payment

script.
    (function () {
        const maxFamilyMembers = !{maxFamilyMembers};
        const container = document.getElementById('family-members-container');
        const addBtn = document.getElementById('add-family-member');
        const primaryLastName = document.getElementById('last_name');

        if (!container) return; // Not a family membership

        function reindex() {
            container.querySelectorAll('.family-member-row').forEach((row, i) => {
                row.querySelectorAll('input').forEach(input => {
                    const name = input.getAttribute('name');
                    if (name) input.setAttribute('name', name.replace(/family_members\[\d+\]/, 'family_members[' + i + ']'));
                });
            });
            updateAddButton();
        }

        function rowCount() {
            return container.querySelectorAll('.family-member-row').length;
        }

        function updateAddButton() {
            if (addBtn) addBtn.style.display = rowCount() >= maxFamilyMembers - 1 ? 'none' : 'inline-block';
        }

        // Wire up remove buttons on existing rows
        container.querySelectorAll('.remove-family-member').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.family-member-row').remove();
                reindex();
            });
        });

        // Add new family member row
        if (addBtn) {
            addBtn.addEventListener('click', () => {
                if (rowCount() >= maxFamilyMembers - 1) return;
                const i = rowCount();
                const lastName = primaryLastName ? primaryLastName.value : '';
                const row = document.createElement('div');
                row.className = 'family-member-row';
                row.style.cssText = 'border:1px solid #ddd; padding:1rem; margin-bottom:1rem; border-radius:4px; position:relative;';
                row.innerHTML =
                    '<button type="button" class="remove-family-member" style="position:absolute; top:0.5rem; right:0.5rem; background:#dc3545; color:white; border:none; border-radius:3px; padding:0.25rem 0.5rem; cursor:pointer;">Remove</button>' +
                    '<div class="form-group"><label>First Name</label><input type="text" name="family_members[' + i + '][first_name]" required></div>' +
                    '<div class="form-group"><label>Last Name</label><input type="text" name="family_members[' + i + '][last_name]" value="' + lastName.replace(/"/g, '&quot;') + '" required></div>' +
                    '<div class="form-group"><label>Email (optional)</label><input type="email" name="family_members[' + i + '][email]"></div>';
                row.querySelector('.remove-family-member').addEventListener('click', () => {
                    row.remove();
                    reindex();
                });
                container.appendChild(row);
                updateAddButton();
            });
        }
    })();
