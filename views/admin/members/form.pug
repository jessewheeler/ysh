extends ../layout

block page_title
  if member
    | Edit Member
  else
    | New Member

block content
  form(method="POST" action=member ? `/admin/members/${member.id}` : '/admin/members')
    if !member
      .form-group
        label Membership Type
        .radio-group(style="margin-bottom: 1rem;")
          label(style="display: inline-block; margin-right: 2rem;")
            input(type="radio" name="membership_type" value="individual" checked)
            |  Individual
          label(style="display: inline-block;")
            input(type="radio" name="membership_type" value="family")
            |  Family

    .form-grid
      .form-group
        label(for="first_name") First Name *
        input#first_name(type="text" name="first_name" value=(member ? member.first_name : '') required)
      .form-group
        label(for="last_name") Last Name *
        input#last_name(type="text" name="last_name" value=(member ? member.last_name : '') required)
      .form-group
        label(for="email") Email *
        input#email(type="email" name="email" value=(member ? member.email : '') required)
      .form-group
        label(for="phone") Phone
        input#phone(type="tel" name="phone" value=(member ? member.phone : ''))
      .form-group
        label(for="address_street") Street
        input#address_street(type="text" name="address_street" value=(member ? member.address_street : ''))
      .form-group
        label(for="address_city") City
        input#address_city(type="text" name="address_city" value=(member ? member.address_city : ''))
      .form-group
        label(for="address_state") State
        input#address_state(type="text" name="address_state" value=(member ? member.address_state : 'MT'))
      .form-group
        label(for="address_zip") ZIP
        input#address_zip(type="text" name="address_zip" value=(member ? member.address_zip : ''))
      .form-group
        label(for="membership_year") Membership Year
        input#membership_year(type="number" name="membership_year" value=(member ? member.membership_year : new Date().getFullYear()))
      .form-group
        label(for="join_date") Join Date
        input#join_date(type="date" name="join_date" value=(member && member.join_date ? member.join_date.split(' ')[0] : ''))
      .form-group
        label(for="status") Status
        select#status(name="status")
          option(value="pending" selected=(member && member.status === 'pending')) Pending
          option(value="active" selected=(member && member.status === 'active')) Active
          option(value="expired" selected=(member && member.status === 'expired')) Expired
          option(value="cancelled" selected=(member && member.status === 'cancelled')) Cancelled
    .form-group
      label(for="notes") Notes
      textarea#notes(name="notes" rows="3")= member ? member.notes : ''

    if !member
      #family-members-section(style="display: none; margin-top: 2rem;")
        h3 Additional Family Members
        p.text-muted Add family members (optional). Each will receive their own member number and card.

        #family-members-container
          //- Dynamic family member rows added by JS

        button.btn-outline(type="button" id="add-family-member") + Add Family Member

    .form-actions
      button.btn(type="submit")= member ? 'Update Member' : 'Create Member'
      a.btn-outline(href="/admin/members") Cancel

  if !member
    script.
      (function() {
        const familySection = document.getElementById('family-members-section');
        const familyContainer = document.getElementById('family-members-container');
        const addBtn = document.getElementById('add-family-member');
        const radios = document.querySelectorAll('input[name="membership_type"]');
        const primaryLastName = document.getElementById('last_name');

        let familyMemberCount = 0;

        // Toggle family section visibility
        radios.forEach(radio => {
          radio.addEventListener('change', () => {
            familySection.style.display = radio.value === 'family' ? 'block' : 'none';
          });
        });

        // Add family member row
        addBtn.addEventListener('click', () => {
          const index = familyMemberCount;
          const currentLastName = primaryLastName.value || '';
          const row = document.createElement('div');
          row.className = 'family-member-row';
          row.style.cssText = 'border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; position: relative;';
          row.innerHTML = `
            <button type="button" class="remove-family-member" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #dc3545; color: white; border: none; border-radius: 3px; padding: 0.25rem 0.5rem; cursor: pointer;">Remove</button>
            <div class="form-grid">
              <div class="form-group">
                <label>First Name</label>
                <input type="text" name="family_members[${index}][first_name]" required>
              </div>
              <div class="form-group">
                <label>Last Name</label>
                <input type="text" name="family_members[${index}][last_name]" value="${currentLastName}" required>
              </div>
              <div class="form-group">
                <label>Email (optional)</label>
                <input type="email" name="family_members[${index}][email]">
              </div>
            </div>
          `;

          row.querySelector('.remove-family-member').addEventListener('click', () => {
            row.remove();
            familyMemberCount--;
          });

          familyContainer.appendChild(row);
          familyMemberCount++;
        });
      })();
