extends ../layout

block page_title
  | #{member.first_name} #{member.last_name}

block content
  .admin-grid
    .admin-panel
      h3 Member Details
      table.detail-table
        tr
          th Member Number
          td= member.member_number
        tr
          th Name
          td= `${member.first_name} ${member.last_name}`
        tr
          th Email
          td= member.email
        tr
          th Phone
          td= member.phone || '—'
        tr
          th Address
          td= [member.address_street, member.address_city, member.address_state, member.address_zip].filter(Boolean).join(', ') || '—'
        tr
          th Year
          td= member.membership_year
        tr
          th Join Date
          td= formatDate(member.join_date)
        tr
          th Status
          td
            span(class=`badge badge-${member.status}`)= member.status
        if member.membership_type
          tr
            th Membership Type
            td= member.membership_type === 'family' ? 'Family' : 'Individual'
        if member.primary_member_id && primaryMember
          tr
            th Primary Member
            td
              a(href=`/admin/members/${primaryMember.id}`) #{primaryMember.first_name} #{primaryMember.last_name} (#{primaryMember.member_number})
        else if member.membership_type === 'family'
          tr
            th Family Members
            td
              if familyMembers.length
                ul(style="margin: 0 0 0.5rem; padding-left: 1.5rem;")
                  each fm in familyMembers
                    li(style="margin-bottom: 0.25rem;")
                      a(href=`/admin/members/${fm.id}`) #{fm.first_name} #{fm.last_name} (#{fm.member_number})
                      |
                      - const confirmMsg = fm.wouldDeleteOnRemove ? `${fm.first_name} ${fm.last_name} shares an email with an existing primary member — removing them will permanently delete their record. Continue?` : `Remove ${fm.first_name} ${fm.last_name} from this family membership?`
                      form(method="POST" action=`/admin/members/${member.id}/family-members/${fm.id}/remove` style="display:inline" data-confirm=confirmMsg)
                        button.btn-sm.btn-danger(type="submit" style="padding: 1px 8px; font-size: 0.75rem;")= fm.wouldDeleteOnRemove ? 'Remove (deletes record)' : 'Remove'
              else
                span.text-muted No family members yet.
        tr
          th Notes
          td= member.notes || '—'
        tr
          th Created
          td= formatDate(member.created_at)
        tr
          th Updated
          td= formatDate(member.updated_at)

      .form-actions
        a.btn(href=`/admin/members/${member.id}?edit=1`) Edit
        form(method="POST" action=`/admin/members/${member.id}/card` style="display:inline")
          button.btn-outline(type="submit") Generate Card
        if !member.primary_member_id
          form(method="POST" action=`/admin/members/${member.id}/send-renewal` style="display:inline" data-confirm=`Send renewal reminder to ${member.first_name} ${member.last_name}?`)
            button.btn-outline(type="submit") Send Renewal Reminder
        if member.membership_type !== 'family' && !member.primary_member_id
          form(method="POST" action=`/admin/members/${member.id}/upgrade-to-family` style="display:inline" data-confirm=`Upgrade ${member.first_name} ${member.last_name} to a family membership?`)
            button.btn-outline(type="submit") Upgrade to Family
        form(method="POST" action=`/admin/members/${member.id}/delete` style="display:inline" data-confirm="Delete this member?")
          button.btn-danger(type="submit") Delete

    .admin-panel
      h3 Membership Cards
      if cards.length
        each card in cards
          .card-row
            span Year: #{card.year}
            if card.pdf_path
              a.btn-sm(href=`/admin/members/${member.id}/card/pdf`) PDF
            if card.png_path
              a.btn-sm(href=`/admin/members/${member.id}/card/png`) PNG
            form(method="POST" action=`/admin/members/${member.id}/email-card` style="display:inline")
              button.btn-sm(type="submit") Email Card
      else
        p.text-muted No cards generated yet.

  if member.membership_type !== 'family' && !member.primary_member_id && familyPrimaries.length
    .admin-panel
      h3 Attach to Family
      form(method="POST" action=`/admin/members/${member.id}/attach-to-family`)
        .form-group
          label(for="primary_member_id") Family
          select#primary_member_id.form-control(name="primary_member_id" required)
            option(value="" disabled selected) — select a family —
            each p in familyPrimaries
              option(value=p.id) #{p.first_name} #{p.last_name} (#{p.member_number})
        .form-actions
          button.btn(type="submit") Attach to Family

  if member.membership_type === 'family' && !member.primary_member_id
    .admin-panel
      h3 Add Family Member
      form(method="POST" action=`/admin/members/${member.id}/family-members`)
        .form-group
          label(for="fm_first_name") First Name
          input#fm_first_name.form-control(type="text" name="first_name" required)
        .form-group
          label(for="fm_last_name") Last Name
          input#fm_last_name.form-control(type="text" name="last_name" required)
        .form-group
          label(for="fm_email") Email (optional)
          input#fm_email.form-control(type="email" name="email" placeholder=`Defaults to ${member.email}`)
        .form-actions
          button.btn(type="submit") Add Family Member

  .admin-panel
    h3 Payments
    if payments.length
      table.admin-table
        thead
          tr
            th Amount
            th Status
            th Method
            th Description
            th Date
        tbody
          each p in payments
            tr
              td $#{(p.amount_cents / 100).toFixed(2)}
              td
                span(class=`badge badge-${p.status}`)= p.status
              td= p.payment_method || 'stripe'
              td= p.description || '—'
              td= formatDate(p.created_at)
    else
      p.text-muted No payments yet.

  .admin-panel
    h3 Record Offline Payment
    form(method="POST" action=`/admin/members/${member.id}/payments`)
      .form-group
        label(for="amount") Amount ($)
        input#amount.form-control(type="number" name="amount" step="0.01" min="0.01" required)
      .form-group
        label(for="payment_method") Payment Method
        select#payment_method.form-control(name="payment_method")
          option(value="cash") Cash
          option(value="check") Check
          option(value="other") Other
      .form-group
        label(for="description") Description
        input#description.form-control(type="text" name="description" placeholder="Membership dues")
      .form-group
        label
          if member.status !== 'active'
            input(type="checkbox" name="activate_member" checked)
          else
            input(type="checkbox" name="activate_member")
          |  Activate member
      .form-actions
        button.btn(type="submit") Record Payment

  .admin-panel
    h3 Recent Emails
    if emails.length
      table.admin-table
        thead
          tr
            th Subject
            th Type
            th Status
            th Date
        tbody
          each e in emails
            tr
              td= e.subject
              td= e.email_type
              td= e.status
              td= formatDate(e.created_at)
    else
      p.text-muted No emails sent yet.
