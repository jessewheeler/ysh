extends layout

block content
  section.section.alt-bg
    .container
      h2 Become a Member
      p.text-center Join the Yellowstone Sea Hawkers and receive your official membership card!

      form.contact-form(method="POST" action="/membership")
        input(type="hidden" name="_csrf" value=(typeof csrfToken !== 'undefined' ? csrfToken : ''))

        //- Membership Type Selection
        .form-group
          label Membership Type
          .radio-group(style="margin-bottom: 1rem;")
            label(style="display: block; margin-bottom: 0.5rem;")
              input(type="radio" name="membership_type" value="individual" checked)
              |  Individual - $#{(individualDues / 100).toFixed(2)}
            label(style="display: block;")
              input(type="radio" name="membership_type" value="family")
              |  Family (up to #{maxFamilyMembers} members) - $#{(familyDues / 100).toFixed(2)}

        //- Primary Member Information
        h3(style="margin-top: 1.5rem;") Primary Member Information
        .form-group
          label(for="first_name") First Name
          input#first_name(type="text" name="first_name" required)
        .form-group
          label(for="last_name") Last Name
          input#last_name(type="text" name="last_name" required)
        .form-group
          label(for="email") Email
          input#email(type="email" name="email" required)
        .form-group
          label(for="phone") Phone (optional)
          input#phone(type="tel" name="phone")
        .form-group
          label(for="address_street") Street Address (optional)
          input#address_street(type="text" name="address_street")
        .form-group
          label(for="address_city") City
          input#address_city(type="text" name="address_city")
        .form-group
          label(for="address_state") State
          input#address_state(type="text" name="address_state" value="MT")
        .form-group
          label(for="address_zip") ZIP Code
          input#address_zip(type="text" name="address_zip")

        //- Family Members Section (hidden by default)
        #family-members-section(style="display: none; margin-top: 2rem;")
          h3 Additional Family Members
          p.text-muted You may add up to #{maxFamilyMembers - 1} additional family members. Each will receive their own membership card.

          #family-members-container
            //- Dynamic family member rows added by JS

          button.btn-outline(type="button" id="add-family-member") + Add Family Member

        button.btn(type="submit" style="margin-top: 2rem;") Continue to Payment

  script.
    (function() {
      const maxFamilyMembers = #{maxFamilyMembers};
      const familySection = document.getElementById('family-members-section');
      const familyContainer = document.getElementById('family-members-container');
      const addBtn = document.getElementById('add-family-member');
      const radios = document.querySelectorAll('input[name="membership_type"]');
      const primaryLastName = document.getElementById('last_name');

      let familyMemberCount = 0;

      // Toggle family section visibility
      radios.forEach(radio => {
        radio.addEventListener('change', () => {
          familySection.style.display = radio.value === 'family' ? 'block' : 'none';
        });
      });

      // Add family member row
      addBtn.addEventListener('click', () => {
        if (familyMemberCount >= maxFamilyMembers - 1) {
          alert(`Maximum ${maxFamilyMembers - 1} additional family members allowed.`);
          return;
        }

        const index = familyMemberCount;
        const currentLastName = primaryLastName.value || '';
        const row = document.createElement('div');
        row.className = 'family-member-row';
        row.style.cssText = 'border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; position: relative;';
        row.innerHTML = `
          <button type="button" class="remove-family-member" style="position: absolute; top: 0.5rem; right: 0.5rem; background: #dc3545; color: white; border: none; border-radius: 3px; padding: 0.25rem 0.5rem; cursor: pointer;">Remove</button>
          <div class="form-group">
            <label>First Name</label>
            <input type="text" name="family_members[${index}][first_name]" required>
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" name="family_members[${index}][last_name]" value="${currentLastName}" required>
          </div>
          <div class="form-group">
            <label>Email (optional - children can use primary member's email)</label>
            <input type="email" name="family_members[${index}][email]">
          </div>
        `;

        row.querySelector('.remove-family-member').addEventListener('click', () => {
          row.remove();
          familyMemberCount--;
          updateAddButtonVisibility();
        });

        familyContainer.appendChild(row);
        familyMemberCount++;
        updateAddButtonVisibility();
      });

      function updateAddButtonVisibility() {
        addBtn.style.display = familyMemberCount >= maxFamilyMembers - 1 ? 'none' : 'inline-block';
      }
    })();
